# Утилиты для работы с электронной почтой

## Общая информация

В этом каталоге находятся утилиты для работы с электронной почтой в проекте АвтоАукцион. Эти утилиты помогают решать различные задачи, связанные с отправкой электронных писем, диагностикой проблем и настройкой почтовых сервисов.

## Проблемы с кодировкой Unicode

Одна из распространенных проблем при работе с SMTP-серверами - некорректная обработка символов Unicode в паролях и других строках. Чтобы решить эту проблему, мы реализовали функцию `sanitize_password` в модуле `email_config.py`, которая автоматически заменяет проблемные символы на их ASCII-эквиваленты.

### Примеры проблемных символов:

- Em Dash (—): `\u2014`
- En Dash (–): `\u2013`
- Кавычки: `\u2018`, `\u2019`, `\u201C`, `\u201D`

### Как это работает

Функция анализирует входную строку и заменяет все символы Unicode на их ASCII-эквиваленты:

```python
def sanitize_password(password):
    """
    Очищает пароль от Unicode-символов, которые могут вызвать проблемы с кодировкой.
    Заменяет проблемные символы на их ASCII-эквиваленты.
    """
    if not password:
        return password
        
    # Словарь замен для известных проблемных символов
    replacements = {
        '\u2014': '-',  # Символ em dash (—) заменяем на обычный дефис
        '\u2013': '-',  # Символ en dash (–) заменяем на обычный дефис
        '\u2018': "'",  # Одинарная открывающая кавычка заменяем на обычный апостроф
        '\u2019': "'",  # Одинарная закрывающая кавычка заменяем на обычный апостроф
        '\u201C': '"',  # Двойная открывающая кавычка заменяем на обычную
        '\u201D': '"',  # Двойная закрывающая кавычка заменяем на обычную
    }
    
    # Замена известных символов
    clean_password = ""
    for char in password:
        if ord(char) > 127:  # Заменяем non-ASCII символы
            replacement = replacements.get(char, '_')  # Используем замену из словаря или подчеркивание
            clean_password += replacement
        else:
            clean_password += char
            
    return clean_password
```

## Доступные утилиты

### 1. email_config.py

Этот модуль содержит функции для настройки параметров электронной почты:

- `sanitize_password`: Очищает пароли от проблемных Unicode-символов
- `get_email_domain`: Извлекает домен из адреса электронной почты
- `get_smtp_settings`: Возвращает настройки SMTP для известных почтовых доменов
- `setup_email_config`: Автоматически настраивает параметры электронной почты
- `apply_email_settings`: Применяет пользовательские настройки электронной почты

### 2. email_service.py

Модуль для отправки электронных писем с различными шаблонами:

- `EmailService.send_email`: Отправляет электронное письмо с HTML-шаблоном
- `EmailService.send_verification_email`: Отправляет письмо для подтверждения адреса
- `EmailService.send_password_reset_email`: Отправляет письмо для сброса пароля
- `EmailService.test_email_configuration`: Тестирует конфигурацию email
- `EmailService.debug_smtp_connection`: Диагностика подключения к SMTP серверу
- `EmailService.analyze_string_encoding`: Анализирует строку на наличие non-ASCII символов

### 3. google_mail_helper.py

Помощник для настройки отправки почты через Gmail:

```bash
cd backend
python utils/google_mail_helper.py
```

Скрипт проведет вас через процесс:
1. Включения двухфакторной аутентификации (2FA) для аккаунта Google
2. Создания специального пароля приложения
3. Сохранения настроек в файл .env

### 4. test_email_and_diagnostics.py

Интерактивный скрипт для тестирования и диагностики отправки электронных писем:

```bash
cd backend
python utils/test_email_and_diagnostics.py
```

Скрипт предлагает следующие опции:
1. Проверка соединения с SMTP сервером
2. Отправка тестового письма
3. Запуск расширенной диагностики
4. Настройка Gmail (через google_mail_helper.py)

## Проблемы с Gmail

Начиная с мая 2022 года, Google отключил опцию "Разрешить небезопасные приложения" для всех аккаунтов Gmail. Теперь для использования Gmail в качестве SMTP-сервера необходимо:

1. Включить двухфакторную аутентификацию (2FA) на аккаунте Google
2. Создать специальный пароль приложения для использования в приложении

Утилита `google_mail_helper.py` поможет вам пройти через этот процесс.

## Отладка проблем

Если у вас возникают проблемы с отправкой электронных писем, используйте скрипт `test_email_and_diagnostics.py` для диагностики. Этот скрипт поможет:

1. Проверить соединение с SMTP сервером
2. Проанализировать параметры конфигурации
3. Выявить проблемы с кодировкой
4. Протестировать отправку тестового письма

## Настройки по умолчанию

Если не указаны иные настройки, система автоматически определяет параметры SMTP на основе адреса электронной почты:

- Gmail: smtp.gmail.com:587 (TLS)
- Outlook/Hotmail: smtp-mail.outlook.com:587 (TLS)
- Yahoo: smtp.mail.yahoo.com:587 (TLS)
- Yandex: smtp.yandex.ru:587 (TLS)
- Mail.ru: smtp.mail.ru:587 (TLS)

Настройки можно изменить через переменные окружения в файле `.env`.